define("local_da_courses/qasync", ["core/ajax", "core/notification"], function (Ajax, Notification) {
    "use strict";
    function getUncheckedIds(container) {
        var out = [];
        container.querySelectorAll('input[type="checkbox"]').forEach(function (cb) {
            if (cb && cb.checked === false) {
                var id = parseInt(cb.dataset.qaid, 10);
                if (id) out.push(id);
            }
        });
        return out.join("+");
    }
    function applyUpdates(container, updated) {
        updated.forEach(function (row) {
            var li = container.querySelector('li.qa-item[data-qaid="' + row.id + '"]');
            if (!li) return;
            jQuery('.qa-details[data-qaid="' + row.id + '"]').fadeOut(200, function() {
                var s = li.querySelector(".qa-qsummary");
                var q = li.querySelector(".qa-qtext");
                var a = li.querySelector(".qa-atext");
                if (q) s.textContent = row.qtext;
                if (q) q.textContent = row.qtext;
                if (a) a.innerHTML = row.atext.replace(/\n/g, "<br>");
                jQuery(this).fadeIn(300);
            });
        });
    }
    function onSyncClick(btn) {
        // if (!courseId) return;
        // var container = btn.closest('[data-courseid="' + courseId + '"]') || btn.closest(".course-block");
        // if (!container) container = document;
        var courseId = parseInt(btn.dataset.courseid, 10);
        var fileid = parseInt(btn.dataset.fileid, 10);
        var container = btn.closest(".qa-list");
        var qaids = getUncheckedIds(container);
        if (!qaids) return false;
        btn.disabled = true;
        btn.classList.add("disabled");
        var req = Ajax.call([{ methodname: "local_da_courses_sync_questions", args: { courseid: courseId, fileid: fileid, qaids: qaids } }])[0];
        req.then(function (res) {
            applyUpdates(container, res.updated || []);
            btn.disabled = false;
            btn.classList.remove("disabled");
            btn.textContent = "Synced (" + (res.count || 0) + ")";
            setTimeout(function () {
                btn.textContent = "Regenerate";
            }, 700);
        }).catch(function (e) {
            console.log(e, 'e');
            btn.disabled = false;
            btn.classList.remove("disabled");
            Notification.exception(e);
        });
    }
    function init() {
        document.querySelectorAll(".qa-regenerate").forEach(function (btn) {
            btn.addEventListener("click", function () {
                onSyncClick(this);
            });
        });
        jQuery(document).on('change', '.qa-approve input[type="checkbox"]', function() {
            var $checkbox = jQuery(this);
            var $btn = $checkbox.parent('label').siblings('.qa-actions').find('button').first();
            var qid = parseInt($checkbox.data('qaid'), 10);

            var $isapproved = $checkbox.is(':checked') ? 1 : 0;
            if ($isapproved) {
                $btn.hide();
            } else {
                $btn.show();
            }
            
            $checkbox.attr('disabled', 'disabled');
            var $label = $checkbox.closest('label.qa-approve');
            $label.css('background-color', 'gray');
            var req = Ajax.call([{ methodname: "local_da_courses_approve_questions", args: { qaid: qid, isapproved: $isapproved } }])[0];
            req.then(function (res) {

                if ($isapproved && res.ok) {
                    // Replace label text with "Approved"
                    $label.contents().filter(function() {
                        return this.nodeType === 3; // text node
                    }).first().replaceWith('Approved');
                } else {
                    // Replace back with "Approve"
                    $label.contents().filter(function() {
                        return this.nodeType === 3;
                    }).first().replaceWith('Approve');
                }
                $label.css('background-color', 'green');
                console.log(res);
                $checkbox.removeAttr('disabled');
                $checkbox.disabled = false;
            }).catch(function (e) {
                $label.css('background-color', 'green');
                $checkbox.removeAttr('disabled');
                Notification.exception(e);
            });
        });
        jQuery(document).on('click', 'button.qa-approve-all', function() {
            var $btn = jQuery(this);
            var courseid = parseInt($btn.data('courseid'), 10);

            $btn.attr('disabled', 'disabled');
            $btn.removeClass('btn-success').addClass('btn-secondary').text('Approving...');
            
            var req = Ajax.call([{ methodname: "local_da_courses_approve_all_questions", args: { courseid: courseid} }])[0];
            req.then(function (res) {
                if (res.ok) {
                    // Update all checkboxes and labels
                    var $ol = $btn.parent().parent().parent();
                    $ol.find('input[type="checkbox"]').each(function() {
                        var $chbox = jQuery(this);
                        $chbox.prop('checked', true);
                        $chbox.closest('label').contents().filter(function() {
                            return this.nodeType === 3; // text node
                        }).first().replaceWith('Approved');
                        $chbox.closest('label').css('background-color', 'green');
                    });
                    $ol.find('button.qa-edit').hide();
                }
                $btn.text('Approve all');
                $btn.removeClass('btn-secondary').addClass('btn-success');
                $btn.removeAttr('disabled');
            }).catch(function (e) {
                $btn.text('Approve all');
                $btn.removeClass('btn-secondary').addClass('btn-success');
                $btn.removeAttr('disabled');
                Notification.exception(e);
            });
        });
    }
    return { init: init };
});
